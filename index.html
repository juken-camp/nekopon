<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê± NEKOPON üê±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #faf8ef;
            color: #776e65;
            font-weight: bold;
            height: 100vh;
            overflow: hidden;
            cursor: pointer;
        }
        
        .field {
            position: absolute;
            top: 90px;
            left: 20px;
            right: 20px;
            bottom: 60px;
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
        }
        
        .title {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            color: #776e65;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            z-index: 1001;
            letter-spacing: 1px;
        }
        
        .header {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            align-items: center;
            z-index: 1000;
            background: rgba(255,255,255,0.1);
            padding: 6px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .score {
            font-size: 14px;
            color: #776e65;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .chain-score {
            font-size: 12px;
            color: #f59563;
            font-family: 'Fredoka One', cursive;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .footer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .btn {
            background: #8f7a66;
            color: #f9f6f2;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #9f8a76;
        }
        
        .btn:disabled {
            background: #ccc2b8;
            cursor: not-allowed;
        }
        
        .cat {
            position: absolute;
            font-size: 45px;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            z-index: 100;
            transform-origin: center;
        }
        
        /* „Çà„ÇäÁ¢∫ÂÆü„Å´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåÂãï‰Ωú„Åô„Çã„Çà„ÅÜ„Å´‰øÆÊ≠£ */
        .cat:not(.dragging):not(.happy):not(.pop):not(.merge) {
            animation: live-idle 3.5s ease-in-out infinite;
        }
        
        .cat:nth-child(6n+1):not(.dragging):not(.happy):not(.pop):not(.merge) {
            animation: live-pulse 3.2s ease-in-out infinite;
        }
        
        .cat:nth-child(6n+2):not(.dragging):not(.happy):not(.pop):not(.merge) {
            animation: live-wiggle 3.8s ease-in-out infinite;
            animation-delay: 0.5s;
        }
        
        .cat:nth-child(6n+3):not(.dragging):not(.happy):not(.pop):not(.merge) {
            animation: live-sway 4.1s ease-in-out infinite;
            animation-delay: 1s;
        }
        
        .cat:nth-child(6n+4):not(.dragging):not(.happy):not(.pop):not(.merge) {
            animation: live-bounce 3.5s ease-in-out infinite;
            animation-delay: 1.5s;
        }
        
        .cat:nth-child(6n+5):not(.dragging):not(.happy):not(.pop):not(.merge) {
            animation: live-rotate 4.3s ease-in-out infinite;
            animation-delay: 2s;
        }
        
        .cat:nth-child(6n+6):not(.dragging):not(.happy):not(.pop):not(.merge) {
            animation: live-breathe 2.9s ease-in-out infinite;
            animation-delay: 0.8s;
        }
        
        @keyframes live-idle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.06) rotate(1deg); }
        }
        
        @keyframes live-pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.08) rotate(2deg); }
            50% { transform: scale(1.15) rotate(0deg); }
            75% { transform: scale(1.05) rotate(-2deg); }
        }
        
        @keyframes live-wiggle {
            0%, 100% { transform: scale(1) rotate(0deg) translateX(0); }
            20% { transform: scale(1.03) rotate(4deg) translateX(-3px); }
            40% { transform: scale(1.08) rotate(-3deg) translateX(3px); }
            60% { transform: scale(1.06) rotate(5deg) translateX(-2px); }
            80% { transform: scale(1.12) rotate(-2deg) translateX(2px); }
        }
        
        @keyframes live-sway {
            0%, 100% { transform: scale(1) rotate(0deg) translateY(0); }
            25% { transform: scale(1.06) rotate(-4deg) translateY(-4px); }
            50% { transform: scale(1.13) rotate(0deg) translateY(-8px); }
            75% { transform: scale(1.04) rotate(4deg) translateY(-3px); }
        }
        
        @keyframes live-bounce {
            0%, 100% { transform: scale(1) translateY(0) rotate(0deg); }
            30% { transform: scale(1.08) translateY(-6px) rotate(3deg); }
            60% { transform: scale(1.16) translateY(-12px) rotate(-2deg); }
            90% { transform: scale(1.05) translateY(-3px) rotate(2deg); }
        }
        
        @keyframes live-rotate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.07) rotate(8deg); }
            50% { transform: scale(1.14) rotate(0deg); }
            75% { transform: scale(1.04) rotate(-8deg); }
        }
        
        @keyframes live-breathe {
            0%, 100% { transform: scale(1) rotate(0deg); }
            33% { transform: scale(1.09) rotate(2deg); }
            66% { transform: scale(1.18) rotate(-2deg); }
        }
        
        .cat:hover {
            transform: scale(1.2) !important;
            animation: none !important;
        }
        
        .cat.dragging {
            transform: scale(1.3) rotate(8deg) !important;
            z-index: 1000;
            animation: none !important;
        }
        
        .cat.happy {
            animation: wiggle 0.8s ease-in-out !important;
        }
        
        .cat.pop {
            animation: pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
        }
        
        .cat.merge {
            animation: merge 0.6s ease-in-out !important;
        }
        
        @keyframes wiggle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.15) rotate(5deg); }
            75% { transform: scale(1.05) rotate(-3deg); }
        }
        
        @keyframes pop {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            60% { transform: scale(1.2) rotate(180deg); opacity: 0.9; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        @keyframes merge {
            0% { transform: scale(1); }
            50% { transform: scale(1.4) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        .floating-score {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            font-size: 18px;
            font-weight: bold;
            color: #f59563;
            pointer-events: none;
            z-index: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            animation: float-up 1.5s ease-out forwards;
        }
        
        @keyframes float-up {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-80px) scale(1.3); 
            }
        }
        
        .msg {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            font-size: 11px;
            color: #8f7a66;
            pointer-events: none;
            z-index: 500;
            animation: float 2s ease-out forwards;
            font-weight: normal;
        }
        
        @keyframes float {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }
        
        .spark {
            position: absolute;
            font-size: 16px;
            pointer-events: none;
            z-index: 400;
            animation: spark 1.5s ease-out forwards;
        }
        
        @keyframes spark {
            0% { opacity: 1; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
            100% { opacity: 0; transform: scale(1.5) rotate(360deg); }
        }
        
        /* „Çπ„Éû„ÉõÂØæÂøú„ÅÆÂ§ßÂπÖÊîπÂñÑ */
        @media (max-width: 480px) {
            .title {
                font-size: 22px;
                top: 10px;
                letter-spacing: 0.5px;
            }
            
            .header {
                top: 50px;
                gap: 8px;
                padding: 5px 12px;
                font-size: 12px;
            }
            
            .score {
                font-size: 12px;
                gap: 3px;
            }
            
            .chain-score {
                font-size: 11px;
                gap: 3px;
            }
            
            .field {
                top: 80px;
            }
            
            .cat {
                font-size: 35px;
            }
            
            .footer {
                gap: 15px;
            }
            
            .btn {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
        
        /* Ë∂ÖÂ∞èÂûã„Çπ„Éû„ÉõÂØæÂøú */
        @media (max-width: 380px) {
            .title {
                font-size: 20px;
            }
            
            .header {
                gap: 6px;
                padding: 4px 10px;
            }
            
            .score, .chain-score {
                font-size: 11px;
            }
            
            .footer {
                gap: 12px;
            }
            
            .btn {
                padding: 4px 8px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="title">üê± NEKOPON üê±</div>
    
    <div class="header">
        <div class="score">‚ú® <span id="score">0</span></div>
        <div class="chain-score">üî• <span id="chainDisplay">0</span></div>
        <div class="score">üèÜ <span id="level">1</span></div>
    </div>
    
    <div class="field" id="field"></div>
    
    <div class="footer">
        <button class="btn" id="auto">ü§ñ <span id="autoCost">100</span></button>
        <button class="btn" id="boost">üí´ <span id="boostCost">300</span></button>
        <button class="btn" id="magic">üåà <span id="magicCost">800</span></button>
    </div>

    <script>
        class Game {
            constructor() {
                this.score = 0;
                this.level = 1;
                this.cats = [];
                this.catId = 0;
                this.helpers = 0;
                this.chainCount = 0;
                this.discovered = new Set();
                this.audioContext = null;
                this.floatingScorePositions = [];
                
                this.types = [
                    'üò∫', 'üò∏', 'üòª', 'üôÄ', 'üòø', 'üòæ', 'üê±', 'üêà', 'üêà‚Äç‚¨õ',
                    'ü¶Å', 'üêØ', 'üê∞', 'üêπ', 'üê≠', 'üê®', 'üêº', 'ü¶ä', 'üê∫', 'üêµ', 'üê∏'
                ];
                
                this.rare = [
                    '‚ú®üò∫', 'üåüüò∏', 'üí´üòª', 'üåôüê±', '‚òÄÔ∏èüêà', 'üåàüôÄ', '‚≠êüòø', 
                    'üíéüòæ', 'üîÆüêà‚Äç‚¨õ', 'üëëü¶Å', 'üéÉüêØ', 'üéàüê∞', 'üé≠üêπ', 'üé™üê≠'
                ];
                
                this.msgs = [
                    '„Åã„Çè„ÅÑ„ÅÑÔºÅ', '„Åô„Å¶„Åç‚ô™', '„Å™„Åã„Çà„Åó', '„Å†„ÅÑ„Åô„Åç', '„Åí„Çì„ÅçÔºÅ',
                    '„Åü„ÅÆ„Åó„ÅÑ', '„ÅÜ„Çå„Åó„ÅÑ', '„ÅÇ„Çä„Åå„Å®„ÅÜ', '„Åô„Åî„ÅÑ„Å≠', '„Çè„ÅÇ„ÅÑÔºÅ'
                ];
                
                this.init();
            }
            
            init() {
                document.getElementById('field').addEventListener('click', (e) => this.spawn(e));
                document.getElementById('auto').addEventListener('click', () => this.buyAuto());
                document.getElementById('boost').addEventListener('click', () => this.buyBoost());
                document.getElementById('magic').addEventListener('click', () => this.buyMagic());
                
                document.getElementById('field').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.spawn({clientX: touch.clientX, clientY: touch.clientY});
                });
                
                // Èü≥Â£∞ÂàùÊúüÂåñ
                document.addEventListener('click', () => this.initSound(), {once: true});
                document.addEventListener('touchstart', () => this.initSound(), {once: true});
                
                setInterval(() => this.update(), 100);
                setInterval(() => this.autoSpawn(), 3000);
                setInterval(() => this.cleanupFloatingPositions(), 200);
                
                this.updateUI();
            }
            
            initSound() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio not supported');
                }
            }
            
            spawn(e) {
                const rect = document.getElementById('field').getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (x < 0 || x > rect.width || y < 0 || y > rect.height) return;
                
                const type = this.getType();
                const cat = {
                    id: this.catId++,
                    x, y,
                    level: 1,
                    type,
                    element: null,
                    birth: Date.now()
                };
                
                cat.element = this.createElement(cat);
                this.cats.push(cat);
                
                const points = 2;
                this.score += points;
                this.discovered.add(type);
                
                this.playAdvancedSound('spawn');
                this.addSpark(x + rect.left, y + rect.top);
                this.showFloatingScore(points, e.clientX, e.clientY);
                this.showMsg(this.msgs[Math.floor(Math.random() * this.msgs.length)], e.clientX, e.clientY);
                
                setTimeout(() => this.checkMerge(), 100);
                this.updateUI();
            }
            
            getType() {
                const rareChance = 0.1 + (this.level * 0.01);
                if (Math.random() < rareChance) {
                    return this.rare[Math.floor(Math.random() * this.rare.length)];
                }
                return this.types[Math.floor(Math.random() * this.types.length)];
            }
            
            createElement(cat) {
                const el = document.createElement('div');
                el.className = 'cat pop';
                el.textContent = cat.type;
                el.style.left = (cat.x - 20) + 'px';
                el.style.top = (cat.y - 20) + 'px';
                
                setTimeout(() => {
                    el.classList.remove('pop');
                }, 500);
                
                this.setupDrag(el, cat);
                document.getElementById('field').appendChild(el);
                return el;
            }
            
            setupDrag(el, cat) {
                let dragging = false;
                let longPress = null;
                
                const start = (e) => {
                    dragging = true;
                    el.classList.add('dragging');
                    longPress = setTimeout(() => this.pet(cat), 600);
                    e.preventDefault();
                };
                
                const end = () => {
                    if (dragging) {
                        dragging = false;
                        el.classList.remove('dragging');
                        clearTimeout(longPress);
                        this.checkMerge();
                    }
                };
                
                const move = (clientX, clientY) => {
                    if (dragging) {
                        clearTimeout(longPress);
                        const rect = document.getElementById('field').getBoundingClientRect();
                        cat.x = Math.max(20, Math.min(rect.width - 20, clientX - rect.left));
                        cat.y = Math.max(20, Math.min(rect.height - 20, clientY - rect.top));
                        el.style.left = (cat.x - 20) + 'px';
                        el.style.top = (cat.y - 20) + 'px';
                        
                        if (Math.random() < 0.1) {
                            this.addSpark(clientX, clientY);
                        }
                    }
                };
                
                el.addEventListener('mousedown', start);
                document.addEventListener('mouseup', end);
                document.addEventListener('mousemove', (e) => move(e.clientX, e.clientY));
                
                el.addEventListener('touchstart', start);
                document.addEventListener('touchend', end);
                el.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 0) {
                        const touch = e.touches[0];
                        move(touch.clientX, touch.clientY);
                    }
                });
            }
            
            pet(cat) {
                cat.element.classList.add('happy');
                const points = 5;
                this.score += points;
                this.playAdvancedSound('purr');
                
                const rect = document.getElementById('field').getBoundingClientRect();
                this.showFloatingScore(points, cat.x + rect.left, cat.y + rect.top);
                this.showMsg('üíï', cat.x + rect.left, cat.y + rect.top);
                
                setTimeout(() => cat.element.classList.remove('happy'), 1000);
                this.updateUI();
            }
            
            showFloatingScore(points, x, y) {
                const adjustedPos = this.getAvailableFloatingPosition(x, y);
                
                const el = document.createElement('div');
                el.className = 'floating-score';
                el.textContent = `+${points}`;
                el.style.left = adjustedPos.x + 'px';
                el.style.top = adjustedPos.y + 'px';
                
                document.body.appendChild(el);
                
                this.floatingScorePositions.push({
                    x: adjustedPos.x,
                    y: adjustedPos.y,
                    time: Date.now()
                });
                
                setTimeout(() => el.remove(), 1500);
            }
            
            getAvailableFloatingPosition(x, y) {
                const now = Date.now();
                const minDistance = 50;
                let attempts = 0;
                let newX = x;
                let newY = y;
                
                while (attempts < 10) {
                    let collision = false;
                    
                    for (const pos of this.floatingScorePositions) {
                        if (now - pos.time < 1000) {
                            const distance = Math.sqrt((newX - pos.x) ** 2 + (newY - pos.y) ** 2);
                            if (distance < minDistance) {
                                collision = true;
                                break;
                            }
                        }
                    }
                    
                    if (!collision) break;
                    
                    newX = x + (Math.random() - 0.5) * 100;
                    newY = y + (Math.random() - 0.5) * 60;
                    attempts++;
                }
                
                return { x: newX, y: newY };
            }
            
            cleanupFloatingPositions() {
                const now = Date.now();
                this.floatingScorePositions = this.floatingScorePositions.filter(pos => 
                    now - pos.time < 2000
                );
            }
            
            checkMerge() {
                for (let i = 0; i < this.cats.length; i++) {
                    for (let j = i + 1; j < this.cats.length; j++) {
                        const a = this.cats[i];
                        const b = this.cats[j];
                        
                        if (this.canMerge(a, b)) {
                            const dist = Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
                            if (dist < 60) {
                                this.merge(a, b, i, j);
                                return;
                            }
                        }
                    }
                }
            }
            
            canMerge(a, b) {
                if (a.level === b.level) return true;
                if (a.type.includes('‚ú®') && b.type.includes('‚ú®')) return true;
                if (Math.abs(a.birth - b.birth) < 3000) return true;
                return false;
            }
            
            merge(a, b, i, j) {
                a.element.classList.add('merge');
                b.element.classList.add('merge');
                
                setTimeout(() => {
                    a.element.remove();
                    b.element.remove();
                    this.cats.splice(Math.max(i, j), 1);
                    this.cats.splice(Math.min(i, j), 1);
                    
                    const newLevel = Math.max(a.level, b.level) + 1;
                    const newCat = {
                        id: this.catId++,
                        x: (a.x + b.x) / 2,
                        y: (a.y + b.y) / 2,
                        level: newLevel,
                        type: this.evolve(a, b, newLevel),
                        element: null,
                        birth: Date.now()
                    };
                    
                    newCat.element = this.createElement(newCat);
                    this.cats.push(newCat);
                    
                    const points = newLevel ** 2 * 5;
                    this.score += points;
                    this.discovered.add(newCat.type);
                    
                    const rect = document.getElementById('field').getBoundingClientRect();
                    this.showFloatingScore(points, newCat.x + rect.left, newCat.y + rect.top);
                    
                    this.chainCount++;
                    this.updateChainDisplay();
                    
                    if (newLevel > this.level) {
                        this.level = newLevel;
                        this.playAdvancedSound('levelup');
                    } else {
                        this.playAdvancedSound('merge');
                    }
                    
                    this.explode(newCat.x + rect.left, newCat.y + rect.top);
                    
                    setTimeout(() => this.checkMerge(), 200);
                    
                }, 200);
                
                this.updateUI();
            }
            
            updateChainDisplay() {
                document.getElementById('chainDisplay').textContent = this.chainCount;
                
                clearTimeout(this.chainTimer);
                this.chainTimer = setTimeout(() => {
                    this.chainCount = 0;
                    document.getElementById('chainDisplay').textContent = '0';
                }, 3000);
            }
            
            evolve(a, b, level) {
                if (a.type.includes('‚ú®') || b.type.includes('‚ú®')) {
                    return this.rare[level % this.rare.length];
                }
                return this.types[(level * 3) % this.types.length];
            }
            
            explode(x, y) {
                const effects = ['üí´', '‚ú®', 'üåü', 'üíñ', 'üéä'];
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        const effect = effects[Math.floor(Math.random() * effects.length)];
                        const dx = (Math.random() - 0.5) * 60;
                        const dy = (Math.random() - 0.5) * 60;
                        this.addSpark(x + dx, y + dy, effect);
                    }, i * 40);
                }
            }
            
            addSpark(x, y, emoji = '‚ú®') {
                const el = document.createElement('div');
                el.className = 'spark';
                el.textContent = emoji;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1500);
            }
            
            showMsg(text, x, y) {
                const el = document.createElement('div');
                el.className = 'msg';
                el.textContent = text;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
            
            playAdvancedSound(type) {
                if (!this.audioContext) return;
                
                try {
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const filterNode = this.audioContext.createBiquadFilter();
                    
                    oscillator.connect(filterNode);
                    filterNode.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    let frequency, duration, filterFreq;
                    
                    switch(type) {
                        case 'spawn':
                            frequency = 500 + Math.random() * 300;
                            duration = 0.4;
                            filterFreq = 1000;
                            break;
                        case 'merge':
                            frequency = 800;
                            duration = 0.8;
                            filterFreq = 2000;
                            break;
                        case 'levelup':
                            frequency = 1200;
                            duration = 1.2;
                            filterFreq = 3000;
                            break;
                        case 'purr':
                            frequency = 200;
                            duration = 2.0;
                            filterFreq = 500;
                            break;
                        default:
                            frequency = 440;
                            duration = 0.3;
                            filterFreq = 1000;
                    }
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(frequency * 0.5, this.audioContext.currentTime + duration);
                    
                    filterNode.frequency.setValueAtTime(filterFreq, this.audioContext.currentTime);
                    filterNode.Q.setValueAtTime(1, this.audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    // Audio error - ignore
                }
            }
            
            buyAuto() {
                const cost = 100 * (2 ** this.helpers);
                if (this.score >= cost) {
                    this.score -= cost;
                    this.helpers++;
                    this.playAdvancedSound('levelup');
                    this.updateUI();
                }
            }
            
            buyBoost() {
                const cost = 300 * (1.5 ** Math.floor(this.score / 1000));
                if (this.score >= cost) {
                    this.score -= cost;
                    this.cats.forEach(cat => {
                        cat.element.classList.add('happy');
                        setTimeout(() => cat.element.classList.remove('happy'), 1500);
                    });
                    this.playAdvancedSound('purr');
                    this.updateUI();
                }
            }
            
            buyMagic() {
                const cost = 800 * (2 ** Math.floor(this.level / 3));
                if (this.score >= cost) {
                    this.score -= cost;
                    
                    for (let i = 0; i < 4; i++) {
                        setTimeout(() => {
                            const rect = document.getElementById('field').getBoundingClientRect();
                            const x = Math.random() * (rect.width - 80) + 40;
                            const y = Math.random() * (rect.height - 80) + 40;
                            
                            this.spawn({
                                clientX: x + rect.left,
                                clientY: y + rect.top
                            });
                        }, i * 150);
                    }
                    
                    this.playAdvancedSound('levelup');
                    this.updateUI();
                }
            }
            
            autoSpawn() {
                if (this.helpers > 0 && Math.random() < 0.3) {
                    const rect = document.getElementById('field').getBoundingClientRect();
                    const x = Math.random() * (rect.width - 60) + 30;
                    const y = Math.random() * (rect.height - 60) + 30;
                    
                    this.spawn({
                        clientX: x + rect.left,
                        clientY: y + rect.top
                    });
                }
            }
            
            update() {
                const rect = document.getElementById('field').getBoundingClientRect();
                this.cats = this.cats.filter(cat => {
                    if (cat.x < -30 || cat.x > rect.width + 30 || 
                        cat.y < -30 || cat.y > rect.height + 30) {
                        cat.element.remove();
                        return false;
                    }
                    return true;
                });
                
                this.updateUI();
            }
            
            updateUI() {
                document.getElementById('score').textContent = this.formatNum(this.score);
                document.getElementById('level').textContent = this.level;
                
                const autoCost = 100 * (2 ** this.helpers);
                const boostCost = 300 * (1.5 ** Math.floor(this.score / 1000));
                const magicCost = 800 * (2 ** Math.floor(this.level / 3));
                
                document.getElementById('autoCost').textContent = this.formatNum(autoCost);
                document.getElementById('boostCost').textContent = this.formatNum(boostCost);
                document.getElementById('magicCost').textContent = this.formatNum(magicCost);
                
                document.getElementById('auto').disabled = this.score < autoCost;
                document.getElementById('boost').disabled = this.score < boostCost;
                document.getElementById('magic').disabled = this.score < magicCost;
            }
            
            formatNum(n) {
                if (n >= 1e6) return Math.floor(n / 1e6) + 'M';
                if (n >= 1e3) return Math.floor(n / 1e3) + 'K';
                return Math.floor(n).toString();
            }
        }
        
        new Game();
    </script>
</body>
</html>