<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê± NEKOPON üê±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'M PLUS Rounded 1c', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #faf8ef;
            color: #776e65;
            font-weight: bold;
            height: 100vh;
            overflow: hidden;
            cursor: pointer;
        }
        
        .field {
            position: absolute;
            top: 110px;
            left: 20px;
            right: 20px;
            bottom: 70px;
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
            pointer-events: none;
        }
        
        .title {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Fredoka One', cursive;
            font-size: 28px;
            color: #776e65;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            z-index: 1001;
            letter-spacing: 1px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease;
        }
        
        .title:hover {
            transform: translateX(-50%) scale(1.05);
        }
        
        .title.shake {
            animation: title-shake 0.6s ease-in-out;
        }
        
        .cat-icon {
            display: inline-block;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 32px;
        }
        
        .cat-icon:hover {
            transform: scale(1.2) rotate(15deg);
        }
        
        .cat-icon.bounce {
            animation: cat-bounce 0.8s ease-in-out;
        }
        
        @keyframes title-shake {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            10% { transform: translateX(-50%) rotate(3deg) scale(1.05); }
            20% { transform: translateX(-50%) rotate(-3deg) scale(1.1); }
            30% { transform: translateX(-50%) rotate(2deg) scale(1.05); }
            40% { transform: translateX(-50%) rotate(-2deg) scale(1.1); }
            50% { transform: translateX(-50%) rotate(1deg) scale(1.15); }
            60% { transform: translateX(-50%) rotate(-1deg) scale(1.1); }
            70% { transform: translateX(-50%) rotate(2deg) scale(1.05); }
            80% { transform: translateX(-50%) rotate(-1deg) scale(1.02); }
            90% { transform: translateX(-50%) rotate(1deg) scale(1.01); }
        }
        
        @keyframes cat-bounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.3) rotate(10deg); }
            50% { transform: scale(1.5) rotate(-5deg); }
            75% { transform: scale(1.2) rotate(8deg); }
        }
        
        .header {
            position: absolute;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            align-items: center;
            z-index: 1000;
            background: rgba(255,255,255,0.15);
            padding: 8px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .score {
            font-size: 18px;
            color: #776e65;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }
        
        .chain-score {
            font-size: 16px;
            color: #f59563;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .combo-display {
            font-size: 14px;
            color: #ff6b6b;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .footer {
            position: absolute;
            bottom: 25px;
            left: 20px;
            right: 20px;
            height: 40px;
            display: flex;
            justify-content: center;
            gap: 25px;
        }
        
        .btn {
            background: #8f7a66;
            color: #f9f6f2;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 15px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            background: #9f8a76;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            background: #ccc2b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .cat {
            position: absolute;
            font-size: 45px;
            cursor: pointer;
            transition: transform 0.1s ease-out;
            user-select: none;
            z-index: 100;
            transform-origin: center;
            pointer-events: auto;
        }
        
        .cat:not(.dragging):not(.happy):not(.pop):not(.merge):not(.combo):not(.gravity) {
            animation: live-idle 3.5s ease-in-out infinite;
        }
        
        .cat.gravity {
            transition: none;
        }
        
        .cat.shake-jump {
            animation: shake-jump 0.8s ease-out;
        }
        
        @keyframes shake-jump {
            0% { transform: translateY(0) scale(1) rotate(0deg); }
            25% { transform: translateY(-20px) scale(1.2) rotate(10deg); }
            50% { transform: translateY(-40px) scale(1.4) rotate(-5deg); }
            75% { transform: translateY(-20px) scale(1.1) rotate(8deg); }
            100% { transform: translateY(0) scale(1) rotate(0deg); }
        }
        
        .cat:nth-child(6n+1):not(.dragging):not(.happy):not(.pop):not(.merge):not(.combo):not(.gravity) {
            animation: live-pulse 3.2s ease-in-out infinite;
        }
        
        .cat:nth-child(6n+2):not(.dragging):not(.happy):not(.pop):not(.merge):not(.combo):not(.gravity) {
            animation: live-wiggle 3.8s ease-in-out infinite;
            animation-delay: 0.5s;
        }
        
        .cat:nth-child(6n+3):not(.dragging):not(.happy):not(.pop):not(.merge):not(.combo):not(.gravity) {
            animation: live-sway 4.1s ease-in-out infinite;
            animation-delay: 1s;
        }
        
        .cat:nth-child(6n+4):not(.dragging):not(.happy):not(.pop):not(.merge):not(.combo):not(.gravity) {
            animation: live-bounce 3.5s ease-in-out infinite;
            animation-delay: 1.5s;
        }
        
        .cat:nth-child(6n+5):not(.dragging):not(.happy):not(.pop):not(.merge):not(.combo):not(.gravity) {
            animation: live-rotate 4.3s ease-in-out infinite;
            animation-delay: 2s;
        }
        
        .cat:nth-child(6n+6):not(.dragging):not(.happy):not(.pop):not(.merge):not(.combo):not(.gravity) {
            animation: live-breathe 2.9s ease-in-out infinite;
            animation-delay: 0.8s;
        }
        
        @keyframes live-idle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.06) rotate(1deg); }
        }
        
        @keyframes live-pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.08) rotate(2deg); }
            50% { transform: scale(1.15) rotate(0deg); }
            75% { transform: scale(1.05) rotate(-2deg); }
        }
        
        @keyframes live-wiggle {
            0%, 100% { transform: scale(1) rotate(0deg) translateX(0); }
            20% { transform: scale(1.03) rotate(4deg) translateX(-3px); }
            40% { transform: scale(1.08) rotate(-3deg) translateX(3px); }
            60% { transform: scale(1.06) rotate(5deg) translateX(-2px); }
            80% { transform: scale(1.12) rotate(-2deg) translateX(2px); }
        }
        
        @keyframes live-sway {
            0%, 100% { transform: scale(1) rotate(0deg) translateY(0); }
            25% { transform: scale(1.06) rotate(-4deg) translateY(-4px); }
            50% { transform: scale(1.13) rotate(0deg) translateY(-8px); }
            75% { transform: scale(1.04) rotate(4deg) translateY(-3px); }
        }
        
        @keyframes live-bounce {
            0%, 100% { transform: scale(1) translateY(0) rotate(0deg); }
            30% { transform: scale(1.08) translateY(-6px) rotate(3deg); }
            60% { transform: scale(1.16) translateY(-12px) rotate(-2deg); }
            90% { transform: scale(1.05) translateY(-3px) rotate(2deg); }
        }
        
        @keyframes live-rotate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.07) rotate(8deg); }
            50% { transform: scale(1.14) rotate(0deg); }
            75% { transform: scale(1.04) rotate(-8deg); }
        }
        
        @keyframes live-breathe {
            0%, 100% { transform: scale(1) rotate(0deg); }
            33% { transform: scale(1.09) rotate(2deg); }
            66% { transform: scale(1.18) rotate(-2deg); }
        }
        
        .cat:hover {
            transform: scale(1.2) !important;
            animation: none !important;
        }
        
        .cat.dragging {
            transform: scale(1.3) rotate(8deg) !important;
            z-index: 1000;
            animation: none !important;
        }
        
        .cat.happy {
            animation: wiggle 0.8s ease-in-out !important;
        }
        
        .cat.pop {
            animation: pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
        }
        
        .cat.merge {
            animation: merge 0.6s ease-in-out !important;
        }
        
        .cat.combo {
            animation: combo-flash 1.2s ease-in-out !important;
        }
        
        @keyframes wiggle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.15) rotate(5deg); }
            75% { transform: scale(1.05) rotate(-3deg); }
        }
        
        @keyframes pop {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            60% { transform: scale(1.2) rotate(180deg); opacity: 0.9; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        
        @keyframes merge {
            0% { transform: scale(1); }
            50% { transform: scale(1.4) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        @keyframes combo-flash {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            25% { transform: scale(1.3); filter: brightness(1.5) hue-rotate(90deg); }
            50% { transform: scale(1.6); filter: brightness(2) hue-rotate(180deg); }
            75% { transform: scale(1.2); filter: brightness(1.3) hue-rotate(270deg); }
        }
        
        .floating-score {
            position: absolute;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: #f59563;
            pointer-events: none;
            z-index: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            animation: float-up 1.5s ease-out forwards;
        }
        
        .floating-score.combo {
            font-size: 28px;
            color: #ff6b6b;
            animation: float-combo 2s ease-out forwards;
        }
        
        @keyframes float-up {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-80px) scale(1.3); 
            }
        }
        
        @keyframes float-combo {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1) rotate(0deg); 
            }
            50% {
                opacity: 1;
                transform: translateY(-40px) scale(1.5) rotate(180deg);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-120px) scale(2) rotate(360deg); 
            }
        }
        
        .msg {
            position: absolute;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #8f7a66;
            pointer-events: none;
            z-index: 500;
            animation: float 2s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
        }
        
        @keyframes float {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }
        
        .spark {
            position: absolute;
            font-size: 20px;
            pointer-events: none;
            z-index: 400;
            animation: spark 1.5s ease-out forwards;
        }
        
        @keyframes spark {
            0% { opacity: 1; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
            100% { opacity: 0; transform: scale(1.5) rotate(360deg); }
        }
        
        .combo-text {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            font-size: 48px;
            font-weight: bold;
            color: #ff6b6b;
            pointer-events: none;
            z-index: 700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            animation: combo-appear 2s ease-out forwards;
        }
        
        @keyframes combo-appear {
            0% { 
                opacity: 0; 
                transform: scale(0) rotate(-180deg); 
            }
            30% {
                opacity: 1;
                transform: scale(1.5) rotate(0deg);
            }
            70% {
                opacity: 1;
                transform: scale(1.2) rotate(10deg);
            }
            100% { 
                opacity: 0; 
                transform: scale(0.8) rotate(180deg); 
            }
        }
        
        .permission-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            text-align: center;
            max-width: 300px;
        }
        
        .permission-popup button {
            background: #8f7a66;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        /* „Çπ„Éû„ÉõÂØæÂøú„ÅÆÂ§ßÂπÖÊîπÂñÑ */
        @media (max-width: 480px) {
            .title {
                font-size: 24px;
                top: 15px;
                letter-spacing: 0.5px;
            }
            
            .cat-icon {
                font-size: 28px;
            }
            
            .header {
                top: 65px;
                gap: 8px;
                padding: 6px 16px;
                flex-wrap: wrap;
            }
            
            .score {
                font-size: 16px;
                gap: 4px;
            }
            
            .chain-score {
                font-size: 14px;
                gap: 4px;
            }
            
            .combo-display {
                font-size: 12px;
                gap: 3px;
            }
            
            .field {
                top: 100px;
            }
            
            .cat {
                font-size: 35px;
            }
            
            .footer {
                gap: 18px;
                bottom: 20px;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }
            
            .msg {
                font-size: 14px;
            }
            
            .floating-score {
                font-size: 18px;
            }
            
            .combo-text {
                font-size: 36px;
            }
            
            .permission-popup {
                max-width: 280px;
                padding: 15px;
            }
        }
        
        /* Ë∂ÖÂ∞èÂûã„Çπ„Éû„ÉõÂØæÂøú */
        @media (max-width: 380px) {
            .title {
                font-size: 22px;
            }
            
            .cat-icon {
                font-size: 26px;
            }
            
            .header {
                gap: 6px;
                padding: 5px 14px;
            }
            
            .score, .chain-score {
                font-size: 14px;
            }
            
            .combo-display {
                font-size: 11px;
            }
            
            .footer {
                gap: 15px;
            }
            
            .btn {
                padding: 7px 12px;
                font-size: 12px;
            }
            
            .msg {
                font-size: 13px;
            }
            
            .floating-score {
                font-size: 16px;
            }
            
            .combo-text {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="title" id="titleElement">
        <span class="cat-icon" id="leftCat">üê±</span> 
        NEKOPON 
        <span class="cat-icon" id="rightCat">üê±</span>
    </div>
    
    <div class="header">
        <div class="score">‚ú® <span id="score">0</span></div>
        <div class="chain-score">üî• <span id="chainDisplay">0</span></div>
        <div class="combo-display">üí• <span id="comboDisplay">0</span></div>
        <div class="score">üèÜ <span id="level">1</span></div>
    </div>
    
    <div class="field" id="field"></div>
    
    <div class="footer">
        <button class="btn" id="auto">ü§ñ <span id="autoCost">100</span></button>
        <button class="btn" id="boost">üí´ <span id="boostCost">300</span></button>
        <button class="btn" id="magic">üåà <span id="magicCost">800</span></button>
    </div>

    <script>
        class Game {
            constructor() {
                this.score = 0;
                this.level = 1;
                this.cats = [];
                this.catId = 0;
                this.helpers = 0;
                this.chainCount = 0;
                this.comboCount = 0;
                this.comboMultiplier = 1;
                this.discovered = new Set();
                this.audioContext = null;
                this.floatingScorePositions = [];
                this.titleTapCount = 0;
                this.titleTapTimer = null;
                this.lastCatType = null;
                this.sameCatStreak = 0;
                this.idleTimer = null;
                this.lastTapTime = Date.now();
                this.fastTapCount = 0;
                this.fastTapTimer = null;
                
                // ÈáçÂäõ„ÉªÂÇæ„ÅçÈñ¢ÈÄ£
                this.gravityEnabled = false;
                this.orientation = { alpha: 0, beta: 0, gamma: 0 };
                this.isUpsideDown = false;
                this.lastShakeTime = 0;
                this.shakeThreshold = 15;
                this.gravityStrength = 0.5;
                
                this.types = [
                    'üò∫', 'üò∏', 'üòª', 'üôÄ', 'üòø', 'üòæ', 'üê±', 'üêà', 'üêà‚Äç‚¨õ',
                    'ü¶Å', 'üêØ', 'üê∞', 'üêπ', 'üê≠', 'üê®', 'üêº', 'ü¶ä', 'üê∫', 'üêµ', 'üê∏'
                ];
                
                this.rare = [
                    '‚ú®üò∫', 'üåüüò∏', 'üí´üòª', 'üåôüê±', '‚òÄÔ∏èüêà', 'üåàüôÄ', '‚≠êüòø', 
                    'üíéüòæ', 'üîÆüêà‚Äç‚¨õ', 'üëëü¶Å', 'üéÉüêØ', 'üéàüê∞', 'üé≠üêπ', 'üé™üê≠'
                ];
                
                // ÊôÇÈôê„Éç„Ç≥
                this.timeBasedCats = {
                    morning: ['‚òÄÔ∏èüò∫', 'üåÖüê±', 'üç≥üêà'],
                    lunch: ['üç±üò∏', 'ü•™üê±', 'üçúüêà'],
                    evening: ['üåÜüòª', 'üíºüê±', 'üç∫üêà'],
                    night: ['üåôüò∫', '‚≠êüê±', 'üí§üêà'],
                    midnight: ['üåÉüò∏', 'üëªüê±', 'ü¶âüêà']
                };
                
                // Â≠£ÁØÄ„Éç„Ç≥
                this.seasonalCats = {
                    newYear: ['üéçüò∫', 'üéåüê±', '‚õ©Ô∏èüêà'],
                    valentine: ['üíùüò∏', 'üç´üê±', 'üíòüêà'],
                    halloween: ['üéÉüò∫', 'üßô‚Äç‚ôÄÔ∏èüê±', 'üëªüêà'],
                    christmas: ['üéÖüò∏', 'üéÑüê±', 'üéÅüêà']
                };
                
                // Èö†„Åó„Éç„Ç≥
                this.secretCats = {
                    ninja: 'ü•∑üò∫',
                    circus: 'üé™üê±',
                    meditation: 'üßò‚Äç‚ôÄÔ∏èüêà',
                    lightning: '‚ö°üò∏',
                    escape: 'üèÉ‚Äç‚ôÇÔ∏èüê±',
                    magic: 'üîÆüòª',
                    upsideDown: 'üôÉüê±',
                    shake: 'üå™Ô∏èüò∫',
                    spin: 'üåÄüêà'
                };
                
                this.msgs = [
                    '„Åã„Çè„ÅÑ„ÅÑÔºÅ', '„Åô„Å¶„Åç‚ô™', '„Å™„Åã„Çà„Åó', '„Å†„ÅÑ„Åô„Åç', '„Åí„Çì„ÅçÔºÅ',
                    '„Åü„ÅÆ„Åó„ÅÑ', '„ÅÜ„Çå„Åó„ÅÑ', '„ÅÇ„Çä„Åå„Å®„ÅÜ', '„Åô„Åî„ÅÑ„Å≠', '„Çè„ÅÇ„ÅÑÔºÅ',
                    '„ÇÑ„Å£„Åü„Å≠ÔºÅ', '„Åô„Å∞„Çâ„Åó„ÅÑ', '„Åç„ÇÉ„Éº‚ô™', '„Çâ„Å∂„Çä„Éº', '„Å∫„Çç„Å∫„Çç'
                ];
                
                this.comboMsgs = [
                    'COMBO!', 'GREAT!', 'EXCELLENT!', 'AMAZING!', 'LEGENDARY!',
                    'ULTIMATE!', 'GODLIKE!', 'IMPOSSIBLE!'
                ];
                
                this.init();
            }
            
            init() {
                // „Éá„Éê„Ç§„ÇπÂÇæ„ÅçÊ§úÁü•„ÅÆÂàùÊúüÂåñ
                this.initDeviceOrientation();
                
                // ÂÖ®ÁîªÈù¢„Çø„ÉÉ„ÉóÂØæÂøú
                document.body.addEventListener('click', (e) => this.handleBodyClick(e));
                document.body.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.handleBodyClick({clientX: touch.clientX, clientY: touch.clientY});
                });
                
                // „Çø„Ç§„Éà„É´Èñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà
                document.getElementById('titleElement').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.handleTitleTap();
                });
                
                document.getElementById('leftCat').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.bounceCat('left');
                });
                
                document.getElementById('rightCat').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.bounceCat('right');
                });
                
                // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
                document.getElementById('auto').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.buyAuto();
                });
                document.getElementById('boost').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.buyBoost();
                });
                document.getElementById('magic').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.buyMagic();
                });
                
                // Èü≥Â£∞ÂàùÊúüÂåñ
                document.addEventListener('click', () => this.initSound(), {once: true});
                document.addEventListener('touchstart', () => this.initSound(), {once: true});
                
                // „Ç¢„Ç§„Éâ„É´„Çø„Ç§„Éû„ÉºÈñãÂßã
                this.startIdleTimer();
                
                setInterval(() => this.update(), 16); // 60FPS for smooth gravity
                setInterval(() => this.autoSpawn(), 3000);
                setInterval(() => this.cleanupFloatingPositions(), 200);
                
                this.updateUI();
            }
            
            initDeviceOrientation() {
                // iOS 13‰ª•Èôç„ÅÆË®±ÂèØË¶ÅÊ±Ç
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    this.showPermissionPopup();
                } else {
                    this.enableDeviceOrientation();
                }
            }
            
            showPermissionPopup() {
                const popup = document.createElement('div');
                popup.className = 'permission-popup';
                popup.innerHTML = `
                    <h3>üê± ÈáçÂäõÊÑüÁü•Ê©üËÉΩ üê±</h3>
                    <p>„Çπ„Éû„Éõ„ÇíÂÇæ„Åë„Çã„Å®Áå´„ÅåÈáçÂäõ„ÅßÁßªÂãï„Åó„Åæ„ÅôÔºÅ</p>
                    <button onclick="game.requestPermission()">ÊúâÂäπ„Å´„Åô„Çã</button>
                    <button onclick="game.skipPermission()">„Çπ„Ç≠„ÉÉ„Éó</button>
                `;
                document.body.appendChild(popup);
                this.permissionPopup = popup;
            }
            
            async requestPermission() {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        this.enableDeviceOrientation();
                        this.showMsg('ÈáçÂäõÊÑüÁü•ÊúâÂäπÔºÅ', window.innerWidth/2, window.innerHeight/2);
                    }
                } catch (error) {
                    console.log('Permission denied');
                }
                this.closePermissionPopup();
            }
            
            skipPermission() {
                this.closePermissionPopup();
            }
            
            closePermissionPopup() {
                if (this.permissionPopup) {
                    this.permissionPopup.remove();
                    this.permissionPopup = null;
                }
            }
            
            enableDeviceOrientation() {
                this.gravityEnabled = true;
                
                // „Éá„Éê„Ç§„ÇπÂÇæ„ÅçÊ§úÁü•
                window.addEventListener('deviceorientation', (event) => {
                    this.orientation.alpha = event.alpha || 0;
                    this.orientation.beta = event.beta || 0;
                    this.orientation.gamma = event.gamma || 0;
                    
                    // ÈÄÜ„Åï„ÅæÊ§úÁü•
                    const wasUpsideDown = this.isUpsideDown;
                    this.isUpsideDown = Math.abs(this.orientation.beta) > 150;
                    
                    if (!wasUpsideDown && this.isUpsideDown) {
                        this.spawnSecretCat('upsideDown');
                    }
                });
                
                // ÊåØÂãïÊ§úÁü•
                window.addEventListener('devicemotion', (event) => {
                    const acceleration = event.accelerationIncludingGravity;
                    if (acceleration) {
                        const totalAcceleration = Math.sqrt(
                            acceleration.x * acceleration.x +
                            acceleration.y * acceleration.y +
                            acceleration.z * acceleration.z
                        );
                        
                        const now = Date.now();
                        if (totalAcceleration > this.shakeThreshold && now - this.lastShakeTime > 1000) {
                            this.lastShakeTime = now;
                            this.handleShake();
                        }
                    }
                });
            }
            
            handleShake() {
                // ÊåØÂãï„ÅßÂÖ®„Éç„Ç≥„Åå„Ç∏„É£„É≥„Éó
                this.cats.forEach(cat => {
                    cat.element.classList.add('shake-jump');
                    setTimeout(() => {
                        cat.element.classList.remove('shake-jump');
                    }, 800);
                });
                
                // ÊåØÂãï„Éç„Ç≥Âè¨Âñö
                if (Math.random() < 0.3) {
                    this.spawnSecretCat('shake');
                }
                
                this.playAdvancedSound('levelup');
                this.massiveExplosion(window.innerWidth/2, window.innerHeight/2);
            }
            
            applyGravity() {
                if (!this.gravityEnabled) return;
                
                const rect = document.getElementById('field').getBoundingClientRect();
                
                // ÂÇæ„Åç„Åã„ÇâÈáçÂäõÊñπÂêë„ÇíË®àÁÆó
                const gravityX = this.orientation.gamma * this.gravityStrength;
                const gravityY = this.orientation.beta * this.gravityStrength;
                
                this.cats.forEach(cat => {
                    if (cat.element.classList.contains('dragging')) return;
                    
                    cat.element.classList.add('gravity');
                    
                    // ÈáçÂäõÈÅ©Áî®
                    let newX = cat.x + gravityX * 0.1;
                    let newY = cat.y + gravityY * 0.1;
                    
                    // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
                    newX = Math.max(20, Math.min(rect.width - 20, newX));
                    newY = Math.max(20, Math.min(rect.height - 20, newY));
                    
                    cat.x = newX;
                    cat.y = newY;
                    
                    // Áå´„ÅÆÂêë„Åç„ÇíÂÇæ„Åç„Å´Âêà„Çè„Åõ„Å¶ÂõûËª¢
                    const rotation = this.orientation.gamma * 0.5;
                    cat.element.style.left = (cat.x - 20) + 'px';
                    cat.element.style.top = (cat.y - 20) + 'px';
                    cat.element.style.transform = `rotate(${rotation}deg)`;
                });
                
                // ÈáçÂäõ„Å´„Çà„Çã„Éû„Éº„Ç∏„ÉÅ„Çß„ÉÉ„ÇØÔºàÈ†ªÂ∫¶„Çí‰∏ã„Åí„ÇãÔºâ
                if (Math.random() < 0.1) {
                    this.checkMerge();
                }
            }
            
            handleTitleTap() {
                this.titleTapCount++;
                clearTimeout(this.titleTapTimer);
                
                if (this.titleTapCount >= 7) {
                    // ÂøçËÄÖ„Éç„Ç≥Âè¨Âñö
                    this.spawnSecretCat('ninja');
                    this.titleTapCount = 0;
                    return;
                }
                
                this.shakeTitle();
                
                this.titleTapTimer = setTimeout(() => {
                    this.titleTapCount = 0;
                }, 2000);
            }
            
            handleBodyClick(e) {
                // È´òÈÄü„Çø„ÉÉ„ÉóÊ§úÂá∫
                const now = Date.now();
                if (now - this.lastTapTime < 100) {
                    this.fastTapCount++;
                    clearTimeout(this.fastTapTimer);
                    
                    if (this.fastTapCount >= 10) {
                        // ÂÖâÈÄü„Éç„Ç≥Âè¨Âñö
                        this.spawnSecretCat('lightning');
                        this.fastTapCount = 0;
                        return;
                    }
                    
                    this.fastTapTimer = setTimeout(() => {
                        this.fastTapCount = 0;
                    }, 1000);
                }
                this.lastTapTime = now;
                
                // „Ç¢„Ç§„Éâ„É´„Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
                this.resetIdleTimer();
                
                // UI„Ç®„É¨„É°„É≥„Éà„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const target = e.target || document.elementFromPoint(e.clientX, e.clientY);
                if (target && (
                    target.closest('.header') || 
                    target.closest('.footer') || 
                    target.closest('.title') ||
                    target.classList.contains('btn') ||
                    target.closest('.permission-popup')
                )) {
                    return;
                }
                
                this.spawn(e);
            }
            
            startIdleTimer() {
                this.idleTimer = setTimeout(() => {
                    // ÁûëÊÉ≥„Éç„Ç≥Âè¨Âñö
                    this.spawnSecretCat('meditation');
                }, 30000); // 30Áßí
            }
            
            resetIdleTimer() {
                clearTimeout(this.idleTimer);
                this.startIdleTimer();
            }
            
            spawnSecretCat(type) {
                const rect = document.getElementById('field').getBoundingClientRect();
                const x = Math.random() * (rect.width - 80) + 40;
                const y = Math.random() * (rect.height - 80) + 40;
                
                const catType = this.secretCats[type];
                const cat = {
                    id: this.catId++,
                    x, y,
                    level: Math.max(1, this.level),
                    type: catType,
                    element: null,
                    birth: Date.now(),
                    secret: true
                };
                
                cat.element = this.createElement(cat);
                this.cats.push(cat);
                
                const points = 50 * this.level;
                this.score += points;
                this.discovered.add(catType);
                
                this.playAdvancedSound('levelup');
                this.massiveExplosion(x + rect.left, y + rect.top);
                this.showFloatingScore(points, x + rect.left, y + rect.top, true);
                this.showMsg('„É¨„Ç¢Áô∫Ë¶ãÔºÅ', x + rect.left, y + rect.top);
                
                this.updateUI();
            }
            
            shakeTitle() {
                const title = document.getElementById('titleElement');
                title.classList.add('shake');
                this.playAdvancedSound('levelup');
                
                // „É©„É≥„ÉÄ„É†„Å™Â†¥ÊâÄ„Å´„Çπ„Éë„Éº„ÇØ„Ç®„Éï„Çß„ÇØ„Éà
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const rect = title.getBoundingClientRect();
                        const x = rect.left + Math.random() * rect.width;
                        const y = rect.top + Math.random() * rect.height;
                        this.addSpark(x, y, '‚≠ê');
                    }, i * 100);
                }
                
                setTimeout(() => {
                    title.classList.remove('shake');
                }, 600);
            }
            
            bounceCat(side) {
                const catId = side === 'left' ? 'leftCat' : 'rightCat';
                const catElement = document.getElementById(catId);
                catElement.classList.add('bounce');
                
                this.playAdvancedSound('purr');
                
                const rect = catElement.getBoundingClientRect();
                this.addSpark(rect.left + rect.width/2, rect.top + rect.height/2, 'üí´');
                
                // „Çπ„Éö„Ç∑„É£„É´„Éú„Éº„Éä„Çπ
                this.score += 10;
                this.showFloatingScore(10, rect.left + rect.width/2, rect.top + rect.height/2);
                this.showMsg('„Å´„ÇÉ„Çì‚ô™', rect.left + rect.width/2, rect.top + rect.height/2);
                
                setTimeout(() => {
                    catElement.classList.remove('bounce');
                }, 800);
                
                this.updateUI();
            }
            
            initSound() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Audio not supported');
                }
            }
            
            spawn(e) {
                const rect = document.getElementById('field').getBoundingClientRect();
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                
                // ÁîªÈù¢Á´Ø„Éâ„É©„ÉÉ„Ç∞Ê§úÂá∫
                if (x < 10 || x > rect.width - 10 || y < 10 || y > rect.height - 10) {
                    this.spawnSecretCat('escape');
                    return;
                }
                
                // „Éï„Ç£„Éº„É´„ÉâÂ§ñ„ÅÆÂ†¥Âêà„ÅØÁØÑÂõ≤ÂÜÖ„Å´Ë™øÊï¥
                if (x < 20) x = 20 + Math.random() * 60;
                if (x > rect.width - 20) x = rect.width - 60 + Math.random() * 40;
                if (y < 20) y = 20 + Math.random() * 60;
                if (y > rect.height - 20) y = rect.height - 60 + Math.random() * 40;
                
                const type = this.getType();
                const cat = {
                    id: this.catId++,
                    x, y,
                    level: 1,
                    type,
                    element: null,
                    birth: Date.now()
                };
                
                cat.element = this.createElement(cat);
                this.cats.push(cat);
                
                // ÈÄ£Á∂öÂêåÁ®Æ„Éç„Ç≥Ê§úÂá∫
                if (this.lastCatType === type) {
                    this.sameCatStreak++;
                    if (this.sameCatStreak >= 5) {
                        this.spawnSecretCat('circus');
                        this.sameCatStreak = 0;
                    }
                } else {
                    this.sameCatStreak = 1;
                }
                this.lastCatType = type;
                
                const basePoints = 2;
                const points = Math.floor(basePoints * this.comboMultiplier);
                this.score += points;
                this.discovered.add(type);
                
                this.playAdvancedSound('spawn');
                this.addSpark(x + rect.left, y + rect.top);
                this.showFloatingScore(points, e.clientX, e.clientY);
                this.showMsg(this.msgs[Math.floor(Math.random() * this.msgs.length)], e.clientX, e.clientY);
                
                setTimeout(() => this.checkMerge(), 100);
                this.updateUI();
            }
            
            getType() {
                const now = new Date();
                const hour = now.getHours();
                const month = now.getMonth() + 1;
                const date = now.getDate();
                
                // Â≠£ÁØÄ„Éç„Ç≥„ÉÅ„Çß„ÉÉ„ÇØ
                if (month === 1 && date === 1 && Math.random() < 0.3) {
                    return this.seasonalCats.newYear[Math.floor(Math.random() * this.seasonalCats.newYear.length)];
                }
                if (month === 2 && date === 14 && Math.random() < 0.3) {
                    return this.seasonalCats.valentine[Math.floor(Math.random() * this.seasonalCats.valentine.length)];
                }
                if (month === 10 && date === 31 && Math.random() < 0.3) {
                    return this.seasonalCats.halloween[Math.floor(Math.random() * this.seasonalCats.halloween.length)];
                }
                if (month === 12 && date === 25 && Math.random() < 0.3) {
                    return this.seasonalCats.christmas[Math.floor(Math.random() * this.seasonalCats.christmas.length)];
                }
                
                // ÊôÇÈñì„Éç„Ç≥„ÉÅ„Çß„ÉÉ„ÇØ
                if (hour >= 6 && hour < 9 && Math.random() < 0.2) {
                    return this.timeBasedCats.morning[Math.floor(Math.random() * this.timeBasedCats.morning.length)];
                }
                if (hour >= 11 && hour < 14 && Math.random() < 0.2) {
                    return this.timeBasedCats.lunch[Math.floor(Math.random() * this.timeBasedCats.lunch.length)];
                }
                if (hour >= 17 && hour < 20 && Math.random() < 0.2) {
                    return this.timeBasedCats.evening[Math.floor(Math.random() * this.timeBasedCats.evening.length)];
                }
                if (hour >= 21 && hour < 24 && Math.random() < 0.2) {
                    return this.timeBasedCats.night[Math.floor(Math.random() * this.timeBasedCats.night.length)];
                }
                if (hour >= 0 && hour < 3 && Math.random() < 0.3) {
                    return this.timeBasedCats.midnight[Math.floor(Math.random() * this.timeBasedCats.midnight.length)];
                }
                
                // „Éë„Çø„Éº„É≥Ëß£Êûê„Éú„Éº„Éä„Çπ
                let rareChance = 0.1 + (this.level * 0.01);
                if (this.sameCatStreak >= 3) rareChance += 0.1;
                if (this.comboMultiplier > 2) rareChance += 0.15;
                
                if (Math.random() < rareChance) {
                    return this.rare[Math.floor(Math.random() * this.rare.length)];
                }
                return this.types[Math.floor(Math.random() * this.types.length)];
            }
            
            createElement(cat) {
                const el = document.createElement('div');
                el.className = 'cat pop';
                el.textContent = cat.type;
                el.style.left = (cat.x - 20) + 'px';
                el.style.top = (cat.y - 20) + 'px';
                
                if (cat.secret) {
                    el.style.filter = 'drop-shadow(0 0 10px #ffgold)';
                }
                
                setTimeout(() => {
                    el.classList.remove('pop');
                }, 500);
                
                this.setupDrag(el, cat);
                document.getElementById('field').appendChild(el);
                return el;
            }
            
            setupDrag(el, cat) {
                let dragging = false;
                let longPress = null;
                
                const start = (e) => {
                    e.stopPropagation();
                    dragging = true;
                    el.classList.add('dragging');
                    el.classList.remove('gravity');
                    longPress = setTimeout(() => this.pet(cat), 600);
                    e.preventDefault();
                };
                
                const end = () => {
                    if (dragging) {
                        dragging = false;
                        el.classList.remove('dragging');
                        clearTimeout(longPress);
                        this.checkMerge();
                    }
                };
                
                const move = (clientX, clientY) => {
                    if (dragging) {
                        clearTimeout(longPress);
                        const rect = document.getElementById('field').getBoundingClientRect();
                        cat.x = Math.max(20, Math.min(rect.width - 20, clientX - rect.left));
                        cat.y = Math.max(20, Math.min(rect.height - 20, clientY - rect.top));
                        el.style.left = (cat.x - 20) + 'px';
                        el.style.top = (cat.y - 20) + 'px';
                        el.style.transform = 'rotate(0deg)'; // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØÂõûËª¢„É™„Çª„ÉÉ„Éà
                        
                        if (Math.random() < 0.1) {
                            this.addSpark(clientX, clientY);
                        }
                    }
                };
                
                el.addEventListener('mousedown', start);
                document.addEventListener('mouseup', end);
                document.addEventListener('mousemove', (e) => move(e.clientX, e.clientY));
                
                el.addEventListener('touchstart', start);
                document.addEventListener('touchend', end);
                el.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 0) {
                        const touch = e.touches[0];
                        move(touch.clientX, touch.clientY);
                    }
                });
            }
            
            pet(cat) {
                cat.element.classList.add('happy');
                const points = Math.floor(5 * this.comboMultiplier);
                this.score += points;
                this.playAdvancedSound('purr');
                
                const rect = document.getElementById('field').getBoundingClientRect();
                this.showFloatingScore(points, cat.x + rect.left, cat.y + rect.top);
                this.showMsg('üíï', cat.x + rect.left, cat.y + rect.top);
                
                setTimeout(() => cat.element.classList.remove('happy'), 1000);
                this.updateUI();
            }
            
            showFloatingScore(points, x, y, isSpecial = false) {
                const adjustedPos = this.getAvailableFloatingPosition(x, y);
                
                const el = document.createElement('div');
                el.className = isSpecial ? 'floating-score combo' : 'floating-score';
                el.textContent = `+${points}`;
                el.style.left = adjustedPos.x + 'px';
                el.style.top = adjustedPos.y + 'px';
                
                document.body.appendChild(el);
                
                this.floatingScorePositions.push({
                    x: adjustedPos.x,
                    y: adjustedPos.y,
                    time: Date.now()
                });
                
                setTimeout(() => el.remove(), isSpecial ? 2000 : 1500);
            }
            
            getAvailableFloatingPosition(x, y) {
                const now = Date.now();
                const minDistance = 50;
                let attempts = 0;
                let newX = x;
                let newY = y;
                
                while (attempts < 10) {
                    let collision = false;
                    
                    for (const pos of this.floatingScorePositions) {
                        if (now - pos.time < 1000) {
                            const distance = Math.sqrt((newX - pos.x) ** 2 + (newY - pos.y) ** 2);
                            if (distance < minDistance) {
                                collision = true;
                                break;
                            }
                        }
                    }
                    
                    if (!collision) break;
                    
                    newX = x + (Math.random() - 0.5) * 100;
                    newY = y + (Math.random() - 0.5) * 60;
                    attempts++;
                }
                
                return { x: newX, y: newY };
            }
            
            cleanupFloatingPositions() {
                const now = Date.now();
                this.floatingScorePositions = this.floatingScorePositions.filter(pos => 
                    now - pos.time < 2000
                );
            }
            
            checkMerge() {
                const mergeGroups = new Map();
                
                // Âêå„Åò„Çø„Ç§„Éó„ÅÆ„Éç„Ç≥„Çí„Ç∞„É´„Éº„ÉóÂåñ
                for (let i = 0; i < this.cats.length; i++) {
                    const cat = this.cats[i];
                    const baseType = cat.type.replace(/[‚ú®üåüüí´üåô‚òÄÔ∏èüåà‚≠êüíéüîÆüëëüéÉüéàüé≠üé™]/g, '');
                    
                    if (!mergeGroups.has(baseType)) {
                        mergeGroups.set(baseType, []);
                    }
                    mergeGroups.get(baseType).push({cat, index: i});
                }
                
                // 3Âåπ‰ª•‰∏ä„ÅÆ„Ç∞„É´„Éº„Éó„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                for (const [type, group] of mergeGroups) {
                    if (group.length >= 3) {
                        // Ë∑ùÈõ¢„ÉÅ„Çß„ÉÉ„ÇØ
                        for (let i = 0; i < group.length; i++) {
                            for (let j = i + 1; j < group.length; j++) {
                                for (let k = j + 1; k < group.length; k++) {
                                    const a = group[i].cat;
                                    const b = group[j].cat;
                                    const c = group[k].cat;
                                    
                                    const dist1 = Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
                                    const dist2 = Math.sqrt((b.x - c.x) ** 2 + (b.y - c.y) ** 2);
                                    const dist3 = Math.sqrt((a.x - c.x) ** 2 + (a.y - c.y) ** 2);
                                    
                                    if (dist1 < 80 && dist2 < 80 && dist3 < 80) {
                                        this.comboMerge([group[i], group[j], group[k]]);
                                        return;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // ÈÄöÂ∏∏„ÅÆ„Éû„Éº„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ
                for (let i = 0; i < this.cats.length; i++) {
                    for (let j = i + 1; j < this.cats.length; j++) {
                        const a = this.cats[i];
                        const b = this.cats[j];
                        
                        if (this.canMerge(a, b)) {
                            const dist = Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
                            if (dist < 60) {
                                this.merge(a, b, i, j);
                                return;
                            }
                        }
                    }
                }
            }
            
            comboMerge(group) {
                // „Ç≥„É≥„Éú„Ç´„Ç¶„É≥„ÉàÂ¢óÂä†
                this.comboCount++;
                this.comboMultiplier = Math.min(8, 1 + this.comboCount * 0.5);
                
                // „Ç≥„É≥„Éú„Ç®„Éï„Çß„ÇØ„Éà
                const centerX = group.reduce((sum, item) => sum + item.cat.x, 0) / group.length;
                const centerY = group.reduce((sum, item) => sum + item.cat.y, 0) / group.length;
                
                // „Éç„Ç≥„Å´„Ç≥„É≥„Éú„ÇØ„É©„ÇπËøΩÂä†
                group.forEach(item => {
                    item.cat.element.classList.add('combo');
                });
                
                setTimeout(() => {
                    // „Éç„Ç≥„ÇíÂâäÈô§
                    const indices = group.map(item => item.index).sort((a, b) => b - a);
                    indices.forEach(index => {
                        this.cats[index].element.remove();
                        this.cats.splice(index, 1);
                    });
                    
                    // Êñ∞„Åó„ÅÑ„É¨„Ç¢„Éç„Ç≥ÁîüÊàê
                    const newLevel = Math.max(...group.map(item => item.cat.level)) + 2;
                    const newCat = {
                        id: this.catId++,
                        x: centerX,
                        y: centerY,
                        level: newLevel,
                        type: this.rare[newLevel % this.rare.length],
                        element: null,
                        birth: Date.now()
                    };
                    
                    newCat.element = this.createElement(newCat);
                    this.cats.push(newCat);
                    
                    const points = Math.floor(newLevel ** 2 * 10 * this.comboMultiplier);
                    this.score += points;
                    this.discovered.add(newCat.type);
                    
                    const rect = document.getElementById('field').getBoundingClientRect();
                    this.showFloatingScore(points, centerX + rect.left, centerY + rect.top, true);
                    
                    this.chainCount++;
                    this.updateChainDisplay();
                    this.updateComboDisplay();
                    
                    // „Ç≥„É≥„Éú„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
                    this.showComboText(centerX + rect.left, centerY + rect.top);
                    
                    if (newLevel > this.level) {
                        this.level = newLevel;
                        this.playAdvancedSound('levelup');
                    } else {
                        this.playAdvancedSound('merge');
                    }
                    
                    this.massiveExplosion(centerX + rect.left, centerY + rect.top);
                    
                    setTimeout(() => this.checkMerge(), 300);
                    
                }, 400);
                
                this.updateUI();
            }
            
            showComboText(x, y) {
                const comboLevel = Math.min(this.comboMsgs.length - 1, this.comboCount - 1);
                const text = this.comboMsgs[comboLevel];
                
                const el = document.createElement('div');
                el.className = 'combo-text';
                el.textContent = text;
                el.style.left = (x - 100) + 'px';
                el.style.top = (y - 50) + 'px';
                
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
            
            canMerge(a, b) {
                if (a.level === b.level) return true;
                if (a.type.includes('‚ú®') && b.type.includes('‚ú®')) return true;
                if (Math.abs(a.birth - b.birth) < 3000) return true;
                return false;
            }
            
            merge(a, b, i, j) {
                a.element.classList.add('merge');
                b.element.classList.add('merge');
                
                setTimeout(() => {
                    a.element.remove();
                    b.element.remove();
                    this.cats.splice(Math.max(i, j), 1);
                    this.cats.splice(Math.min(i, j), 1);
                    
                    const newLevel = Math.max(a.level, b.level) + 1;
                    const newCat = {
                        id: this.catId++,
                        x: (a.x + b.x) / 2,
                        y: (a.y + b.y) / 2,
                        level: newLevel,
                        type: this.evolve(a, b, newLevel),
                        element: null,
                        birth: Date.now()
                    };
                    
                    newCat.element = this.createElement(newCat);
                    this.cats.push(newCat);
                    
                    const points = Math.floor(newLevel ** 2 * 5 * this.comboMultiplier);
                    this.score += points;
                    this.discovered.add(newCat.type);
                    
                    const rect = document.getElementById('field').getBoundingClientRect();
                    this.showFloatingScore(points, newCat.x + rect.left, newCat.y + rect.top);
                    
                    this.chainCount++;
                    this.updateChainDisplay();
                    
                    if (newLevel > this.level) {
                        this.level = newLevel;
                        this.playAdvancedSound('levelup');
                    } else {
                        this.playAdvancedSound('merge');
                    }
                    
                    this.explode(newCat.x + rect.left, newCat.y + rect.top);
                    
                    setTimeout(() => this.checkMerge(), 200);
                    
                }, 200);
                
                this.updateUI();
            }
            
            updateChainDisplay() {
                document.getElementById('chainDisplay').textContent = this.chainCount;
                
                clearTimeout(this.chainTimer);
                this.chainTimer = setTimeout(() => {
                    this.chainCount = 0;
                    document.getElementById('chainDisplay').textContent = '0';
                }, 3000);
            }
            
            updateComboDisplay() {
                document.getElementById('comboDisplay').textContent = this.comboCount;
                
                clearTimeout(this.comboTimer);
                this.comboTimer = setTimeout(() => {
                    this.comboCount = 0;
                    this.comboMultiplier = 1;
                    document.getElementById('comboDisplay').textContent = '0';
                }, 5000);
            }
            
            evolve(a, b, level) {
                if (a.type.includes('‚ú®') || b.type.includes('‚ú®')) {
                    return this.rare[level % this.rare.length];
                }
                return this.types[(level * 3) % this.types.length];
            }
            
            explode(x, y) {
                const effects = ['üí´', '‚ú®', 'üåü', 'üíñ', 'üéä'];
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        const effect = effects[Math.floor(Math.random() * effects.length)];
                        const dx = (Math.random() - 0.5) * 60;
                        const dy = (Math.random() - 0.5) * 60;
                        this.addSpark(x + dx, y + dy, effect);
                    }, i * 40);
                }
            }
            
            massiveExplosion(x, y) {
                const effects = ['üí•', '‚ú®', 'üåü', 'üí´', 'üéä', 'üéÜ', 'üíñ', 'üåà'];
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const effect = effects[Math.floor(Math.random() * effects.length)];
                        const dx = (Math.random() - 0.5) * 120;
                        const dy = (Math.random() - 0.5) * 120;
                        this.addSpark(x + dx, y + dy, effect);
                    }, i * 30);
                }
            }
            
            addSpark(x, y, emoji = '‚ú®') {
                const el = document.createElement('div');
                el.className = 'spark';
                el.textContent = emoji;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1500);
            }
            
            showMsg(text, x, y) {
                const el = document.createElement('div');
                el.className = 'msg';
                el.textContent = text;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
            
            playAdvancedSound(type) {
                if (!this.audioContext) return;
                
                try {
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const filterNode = this.audioContext.createBiquadFilter();
                    
                    oscillator.connect(filterNode);
                    filterNode.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    let frequency, duration, filterFreq;
                    
                    switch(type) {
                        case 'spawn':
                            frequency = 500 + Math.random() * 300;
                            duration = 0.4;
                            filterFreq = 1000;
                            break;
                        case 'merge':
                            frequency = 800;
                            duration = 0.8;
                            filterFreq = 2000;
                            break;
                        case 'levelup':
                            frequency = 1200;
                            duration = 1.2;
                            filterFreq = 3000;
                            break;
                        case 'purr':
                            frequency = 200;
                            duration = 2.0;
                            filterFreq = 500;
                            break;
                        default:
                            frequency = 440;
                            duration = 0.3;
                            filterFreq = 1000;
                    }
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(frequency * 0.5, this.audioContext.currentTime + duration);
                    
                    filterNode.frequency.setValueAtTime(filterFreq, this.audioContext.currentTime);
                    filterNode.Q.setValueAtTime(1, this.audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    // Audio error - ignore
                }
            }
            
            buyAuto() {
                const cost = 100 * (2 ** this.helpers);
                if (this.score >= cost) {
                    this.score -= cost;
                    this.helpers++;
                    this.playAdvancedSound('levelup');
                    this.updateUI();
                }
            }
            
            buyBoost() {
                const cost = 300 * (1.5 ** Math.floor(this.score / 1000));
                if (this.score >= cost) {
                    this.score -= cost;
                    this.cats.forEach(cat => {
                        cat.element.classList.add('happy');
                        setTimeout(() => cat.element.classList.remove('happy'), 1500);
                    });
                    this.playAdvancedSound('purr');
                    this.updateUI();
                }
            }
            
            buyMagic() {
                const cost = 800 * (2 ** Math.floor(this.level / 3));
                if (this.score >= cost) {
                    this.score -= cost;
                    
                    for (let i = 0; i < 4; i++) {
                        setTimeout(() => {
                            const rect = document.getElementById('field').getBoundingClientRect();
                            const x = Math.random() * (rect.width - 80) + 40;
                            const y = Math.random() * (rect.height - 80) + 40;
                            
                            this.spawn({
                                clientX: x + rect.left,
                                clientY: y + rect.top
                            });
                        }, i * 150);
                    }
                    
                    this.playAdvancedSound('levelup');
                    this.updateUI();
                }
            }
            
            autoSpawn() {
                if (this.helpers > 0 && Math.random() < 0.3) {
                    const rect = document.getElementById('field').getBoundingClientRect();
                    const x = Math.random() * (rect.width - 60) + 30;
                    const y = Math.random() * (rect.height - 60) + 30;
                    
                    this.spawn({
                        clientX: x + rect.left,
                        clientY: y + rect.top
                    });
                }
            }
            
            update() {
                const rect = document.getElementById('field').getBoundingClientRect();
                this.cats = this.cats.filter(cat => {
                    if (cat.x < -30 || cat.x > rect.width + 30 || 
                        cat.y < -30 || cat.y > rect.height + 30) {
                        cat.element.remove();
                        return false;
                    }
                    return true;
                });
                
                // ÈáçÂäõÈÅ©Áî®
                this.applyGravity();
                
                this.updateUI();
            }
            
            updateUI() {
                document.getElementById('score').textContent = this.formatNum(this.score);
                document.getElementById('level').textContent = this.level;
                
                const autoCost = 100 * (2 ** this.helpers);
                const boostCost = 300 * (1.5 ** Math.floor(this.score / 1000));
                const magicCost = 800 * (2 ** Math.floor(this.level / 3));
                
                document.getElementById('autoCost').textContent = this.formatNum(autoCost);
                document.getElementById('boostCost').textContent = this.formatNum(boostCost);
                document.getElementById('magicCost').textContent = this.formatNum(magicCost);
                
                document.getElementById('auto').disabled = this.score < autoCost;
                document.getElementById('boost').disabled = this.score < boostCost;
                document.getElementById('magic').disabled = this.score < magicCost;
            }
            
            formatNum(n) {
                if (n >= 1e6) return Math.floor(n / 1e6) + 'M';
                if (n >= 1e3) return Math.floor(n / 1e3) + 'K';
                return Math.floor(n).toString();
            }
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶Ë®≠ÂÆöÔºàÊ®©Èôê„É™„ÇØ„Ç®„Çπ„ÉàÁî®Ôºâ
        const game = new Game();
    </script>
</body>
</html>